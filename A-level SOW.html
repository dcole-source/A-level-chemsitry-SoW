// --- Populate Component Knowledge Table (Table 1) with rowspan support ---
function populateComponentKnowledgeTable(tabIndex) {
    const knowledgeTbody = document.getElementById(`component-knowledge-tbody-${tabIndex}`);
    if (!knowledgeTbody) return;

    knowledgeTbody.innerHTML = ''; // Clear existing
    const topic = topics[tabIndex]; // Get topic name from index

    if (allTable1SheetData.length <= 1) {
        if (knowledgeTbody.innerHTML.includes('Error')) return; 
        knowledgeTbody.innerHTML = `<tr class="bg-white border-b hover:bg-gray-50"><td colspan="4" class="py-4 px-6 italic text-gray-500 text-center">Sheet data is empty or not loaded.</td></tr>`;
        return;
    }

    // FIRST PASS: Collect all rows for this topic
    const topicRows = [];
    for (let i = 1; i < allTable1SheetData.length; i++) {
        const rowData = allTable1SheetData[i];
        if (rowData.length < 6) continue;
        
        const rowTopic = rowData[0] ? rowData[0].trim() : '';
        if (rowTopic === topic) {
            topicRows.push({
                lesson: escapeHTML(rowData[1] || ''),
                learningIntention: escapeHTML(rowData[2] || ''),
                prereq: escapeHTML(rowData[3] || ''),
                componentKnowledge: escapeHTML(rowData[5] || '')
            });
        }
    }

    if (topicRows.length === 0) {
        knowledgeTbody.innerHTML = `<tr class="bg-white border-b hover:bg-gray-50"><td colspan="4" class="py-4 px-6 italic text-gray-500 text-center">No component knowledge found for "${escapeHTML(topic)}".</td></tr>`;
        return;
    }

    // SECOND PASS: Identify lesson groups and calculate rowspan
    const lessonGroups = [];
    let currentGroup = null;

    for (let i = 0; i < topicRows.length; i++) {
        const row = topicRows[i];
        
        if (row.lesson !== '') {
            // Start a new lesson group
            if (currentGroup) {
                lessonGroups.push(currentGroup);
            }
            currentGroup = {
                lesson: row.lesson,
                rowspan: 1,
                rows: [row]
            };
        } else {
            // Empty lesson - add to current group
            if (currentGroup) {
                currentGroup.rowspan++;
                currentGroup.rows.push(row);
            } else {
                // Edge case: empty lesson at start - treat as its own group
                currentGroup = {
                    lesson: '',
                    rowspan: 1,
                    rows: [row]
                };
            }
        }
    }
    
    // Don't forget the last group
    if (currentGroup) {
        lessonGroups.push(currentGroup);
    }

    // THIRD PASS: Render the table with rowspan
    lessonGroups.forEach(group => {
        group.rows.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white border-b hover:bg-gray-50';
            
            // Only add lesson cell for the first row of the group
            if (index === 0) {
                const lessonCell = `<td class="py-4 px-6" rowspan="${group.rowspan}">${group.lesson}</td>`;
                tr.innerHTML = `
                    ${lessonCell}
                    <td class="py-4 px-6">${row.learningIntention}</td>
                    <td class="py-4 px-6">${row.componentKnowledge}</td>
                    <td class="py-4 px-2 text-center">
                        <input type="checkbox" class="component-knowledge-checkbox h-4 w-4 rounded border-gray-300 text-[#31473A] focus:ring-[#31473A]/50" 
                            data-knowledge="${row.componentKnowledge}" 
                            data-prereq="${row.prereq}">
                    </td>
                `;
            } else {
                // Skip lesson cell for subsequent rows in the group
                tr.innerHTML = `
                    <td class="py-4 px-6">${row.learningIntention}</td>
                    <td class="py-4 px-6">${row.componentKnowledge}</td>
                    <td class="py-4 px-2 text-center">
                        <input type="checkbox" class="component-knowledge-checkbox h-4 w-4 rounded border-gray-300 text-[#31473A] focus:ring-[#31473A]/50" 
                            data-knowledge="${row.componentKnowledge}" 
                            data-prereq="${row.prereq}">
                    </td>
                `;
            }
            
            knowledgeTbody.appendChild(tr);
        });
    });
}